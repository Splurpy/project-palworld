<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Pal Entries</title>
        <link rel="stylesheet" href="./styles.css">
    </head>

    <body>
        <div class="big-daddy">
            <div class="search-panel">
                <div class="topPortion">
                    <input type="text" id="searchBox" placeholder="Pal Name..." oninput="filterByName();">
                </div>
                <div id="palContainer" class="container"></div>
                <script src="./dist/sql-wasm.js"></script>
                <script>
                    // Configuration for SQL.js
                    const config = {
                        locateFile: filename => `/dist/${filename}`
                    };

                    // Main logic
                    initSqlJs(config).then(function (SQL) {
                        // Pal class definition
                        class Pal {
                            constructor(tieOrder, dexNum, name, rarity, elem1, elem2, sprintSpeed, breedPower,
                                kindling, watering, planting, genElec, handiwork, gathering, lumbering, mining, medicine, cooling, transporting, farming) {
                                this.tieOrder = tieOrder;
                                this.dexNum = dexNum;
                                this.name = name;
                                this.rarity = rarity;
                                this.elem1 = elem1;
                                this.elem2 = elem2;
                                this.sprintSpeed = sprintSpeed;
                                this.breedPower = breedPower;

                                this.kindling = kindling;
                                this.planting = planting;
                                this.handiwork = handiwork;
                                this.lumbering = lumbering;
                                this.medicine = medicine;
                                this.transporting = transporting;
                                this.watering = watering;
                                this.genElec = genElec;
                                this.gathering = gathering;
                                this.mining = mining;
                                this.cooling = cooling;
                                this.farming = farming;
                            }

                            static async readPals() {
                                try {
                                    const response = await fetch('../db/paldb.db');
                                    const buffer = await response.arrayBuffer();
                                    const db = new SQL.Database(new Uint8Array(buffer));
                                    const query = "SELECT pd.IndexOrder, bp.DexNum, bp.Name, pd.Rarity, pd.ElementType1, pd.ElementType2, pd.RideSprintSpeed, bp.Power, pd.WorkSuitability_EmitFlame, pd.WorkSuitability_Watering, pd.WorkSuitability_Seeding, pd.WorkSuitability_GenerateElectricity, pd.WorkSuitability_Handcraft, pd.WorkSuitability_Collection, pd.WorkSuitability_Deforest, pd.WorkSuitability_Mining, pd.WorkSuitability_ProductMedicine, pd.WorkSuitability_Cool,  pd.WorkSuitability_Transport,  pd.WorkSuitability_MonsterFarm FROM breeding_power bp JOIN pal_data pd ON bp.Name = pd.Name ORDER BY pd.IndexOrder ASC";
                                    const rows = db.exec(query);

                                    if (rows.length > 0) {
                                        const palArray = new Array(138);

                                        rows[0].values.forEach(row => {
                                            const [tieOrder, dexNum, name, rarity, elem1, elem2, sprintSpeed, breedPower, kindling, watering, planting, genElec, handiwork, gathering, lumbering, mining, medicine, cooling, transporting, farming] = row;
                                            const fElem1 = elem1.replace("EPalElementType::", "").toLowerCase();
                                            const fElem2 = elem2.replace("EPalElementType::", "").toLowerCase();
                                            palArray[tieOrder - 1] = new Pal(tieOrder, dexNum, name, rarity, fElem1, fElem2, sprintSpeed, breedPower, kindling, watering, planting, genElec, handiwork, gathering, lumbering, mining, medicine, cooling, transporting, farming);
                                        });

                                        console.log(`Successfully read ${palArray.length} entries`);
                                        return palArray;
                                    } else {
                                        console.log("No data retrieved");
                                        throw new Error("No data retrieved");
                                    }
                                } catch (error) {
                                    console.error(error);
                                    throw error;
                                }
                            }
                        }

                        (async function () {
                            try {
                                const palArray = await Pal.readPals();
                                const palContainer = document.getElementById('palContainer');
                                // Define a global variable to store the currently selected palEntry
                                var selectedPalEntry = null;

                                palArray.forEach(pal => {

                                    const palEntry = document.createElement('div');
                                    palEntry.classList.add('palEntry');

                                    const palImg = document.createElement('img');
                                    palImg.src = `./resource/img/pal/${pal.name}.png`;
                                    palImg.classList.add('palImg');

                                    const palName = document.createElement('div');
                                    palName.classList.add('palName');
                                    palName.textContent = pal.name;

                                    const shineBox = document.createElement('div');
                                    palEntry.classList.add('shineBox');

                                    const element = document.createElement('img');
                                    element.id = `${pal.name}.elem1`;
                                    element.src = `./resource/img/elem/${pal.elem1}.png`;
                                    element.classList.add('element', `${pal.elem1}`);

                                    if (pal.elem2 !== 'none') {
                                        const element2 = document.createElement('img');
                                        element2.id = `${pal.name}.elem2`;
                                        element2.src = `./resource/img/elem/${pal.elem2}.png`;
                                        element2.classList.add('element', 'secondary', `${pal.elem2}`);
                                        palEntry.appendChild(element2);
                                    }

                                    // new div for work plate
                                    const workPlate = document.createElement('div');
                                    workPlate.classList.add('workPlate');

                                    // Work Suitabilities
                                    const workImg = document.createElement('img');
                                    workImg.classList.add('workImg');

                                    const work_suitabilities = ['kindling', 'watering', 'planting', 'genElec', 'handiwork', 'gathering', 'lumbering', 'mining', 'medicine', 'cooling', 'transporting', 'farming'];

                                    // console.log(`PAL: ${pal.name}\nMEDICINE:${pal.medicine}`);

                                    let workImgIndex = 0;
                                    for (let i = 0; i < work_suitabilities.length; i++) {
                                        const suitabilityImg = document.createElement('img');
                                        suitabilityImg.src = `./resource/img/work/${work_suitabilities[i]}.png`;
                                        suitabilityImg.classList.add('workImg', work_suitabilities[i]);
                                        // suitabilityImg.style.setProperty('--lvl', pal[work_suitabilities[i]]);
                                        if (pal[work_suitabilities[i]] == 0) {
                                            suitabilityImg.style.filter = 'grayscale(100%)';
                                        }
                                        if (pal[work_suitabilities[i]] !== 0) {
                                            suitabilityImg.style.setProperty('--index', workImgIndex++);

                                            const workLvl = document.createElement('p');
                                            workLvl.innerText = pal[work_suitabilities[i]];

                                            workLvl.classList.add('workLvl', work_suitabilities[i]);
                                            workLvl.style.setProperty('--index', workImgIndex - 1);
                                            // console.log(`PAL: ${pal.name}\nworkImgIndex: ${workImgIndex - 1}`);
                                            workPlate.appendChild(workLvl);
                                            palEntry.appendChild(suitabilityImg);
                                        }

                                    }


                                    palEntry.addEventListener('click', () => {
                                        const currentPalEntry = event.currentTarget;
                                        currentPalEntry.classList.toggle('selected');
                                        if (selectedPalEntry && selectedPalEntry !== currentPalEntry) {
                                            selectedPalEntry.classList.remove('selected');
                                        }

                                        selectedPalEntry = currentPalEntry.classList.contains('selected') ? currentPalEntry : null;
                                    });




                                    palEntry.appendChild(palImg);
                                    palEntry.appendChild(element);
                                    palEntry.appendChild(palName);
                                    palEntry.appendChild(shineBox);
                                    palEntry.appendChild(workPlate);
                                    palContainer.appendChild(palEntry);
                                });
                            } catch (error) {
                                console.error(error);
                            }
                        })();
                    });
                </script>
            </div>
            <div class="filtersMenuHitbox">
                <div class="filtersMenu">
                    <div class="filtersMenuTab">
                        <p class="tabArrow">
                            &#9660;
                        </p>
                    </div>
                    <div class="hideyMan">
                    </div>
                </div>
            </div>
        </div>

        <script>
            function filterByName() {
                var input, filter, palContainer, palEntries, i;

                input = document.getElementById("searchBox");
                filter = input.value.toUpperCase();
                palContainer = document.getElementById("palContainer");
                palEntries = palContainer.getElementsByClassName("palEntry");

                for (i = 0; i < palEntries.length; i++) {
                    var palName = palEntries[i].getElementsByClassName("palName")[0];
                    var txtValue = palName.textContent || palName.innerText;

                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        palEntries[i].style.display = "";
                    } else {
                        palEntries[i].style.display = "none";
                    }
                }
            }
        </script>
        <script>
            function filterByElem() {
                console.log('button clicked');
                palContainer = document.getElementById("palContainer");
                palEntries = palContainer.getElementsByClassName("palEntry");

                for (i = 0; i < palEntries.length; i++) {
                    let palName = palEntries[i].getElementsByClassName("palName")[0];
                    let elem1 = document.getElementById(`${palName.textContent}.elem1`);
                    let elem2 = document.getElementById(`${palName.textContent}.elem2`);
                    console.log(palName.textContent, elem1, elem2);

                }
            }
        </script>
    </body>

</html>